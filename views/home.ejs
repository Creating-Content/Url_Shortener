<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Short Link - Home</title>
    <style>
        /* Color Palette: Primary Teal (#008080), Accent Green (#28a745), Background Gradient */
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            /* Vibrant Gradient Background */
            background: linear-gradient(135deg, #f0f9ff 0%, #e2eafc 100%);
            color: #333; 
        }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px 40px; 
            background-color: #008080; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.2); 
            color: white;
            animation: fadeIn 0.5s ease-out;
        }
        header h1 { font-weight: 700; margin: 0; }
        .container { 
            max-width: 900px; 
            margin: 50px auto; 
            padding: 30px; 
            background: #ffffff; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.18); 
            animation: fadeIn 0.7s ease-out 0.2s backwards;
        }
        .auth-actions a { 
            margin-left: 15px; 
            text-decoration: none; 
            color: white; 
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 20px; /* Pill-shaped buttons */
            transition: background-color 0.2s, transform 0.1s;
        }
        .auth-actions a:active { transform: scale(0.98); }
        .auth-actions a:hover { background-color: #006666; }

        /* Form Styling */
        .shorten-form label { font-weight: 600; margin-bottom: 5px; display: block; color: #444; }
        .shorten-form input[type="text"] { 
            flex-grow: 1;
            padding: 14px; 
            border: 2px solid #ddd; 
            border-radius: 8px 0 0 8px; 
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .shorten-form input[type="text"]:focus { border-color: #008080; outline: none; }
        .shorten-form button { 
            padding: 14px 25px; 
            border: none; 
            background-color: #28a745; 
            color: white; 
            border-radius: 0 8px 8px 0; 
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.2s, transform 0.1s;
            animation: pulse 2s infinite; /* Subtle pulse animation on button */
        }
        .shorten-form button:hover { background-color: #1e7e34; animation: none; }

        /* Generated Link Display */
        .link-generated {
            background-color: #e6ffec; 
            color: #1e7e34;
            padding: 18px; 
            border-left: 6px solid #28a745;
            border-radius: 8px; 
            margin-bottom: 30px;
            font-size: 1.1rem;
            animation: fadeIn 0.5s ease-out;
        }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 25px; border-radius: 8px; overflow: hidden; }
        th, td { border: 1px solid #e0e0e0; padding: 15px; text-align: left; }
        th { background-color: #008080; color: white; font-weight: 600; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #eaf7f7; }

        /* Popup Styling */
        .popup-backdrop { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-color: rgba(0, 0, 0, 0.7); 
    z-index: 9999; 
    display: none; /* Must be hidden initially */
}
.popup-card { 
    position: fixed; /* ðŸ‘ˆ Use FIXED positioning relative to the viewport */
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); /* ðŸ‘ˆ CRITICAL: Centers the element based on its own size */
    padding: 35px; 
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 15px 35px rgba(0,0,0,0.3); 
    text-align: center; 
    width: 350px;
    animation: fadeIn 0.3s ease-out; /* Apply animation only to opacity/scale, not position */
    z-index: 10000; /* Ensure it's above the backdrop */
}
        .popup-card h3 { color: #d9534f; margin-top: 0; }
        .popup-card button { margin: 10px; padding: 12px 22px; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        .popup-card button:first-of-type { background-color: #008080; color: white; }
        .popup-card button:last-of-type { background-color: #e9ecef; color: #333; }
        .popup-card button:hover:first-of-type { background-color: #006666; }
        .popup-card button:hover:last-of-type { background-color: #ddd; }
        .popup-close { position: absolute; top: 12px; right: 18px; font-size: 28px; cursor: pointer; color: #aaa; transition: color 0.2s; }
        .popup-close:hover { color: #555; }
    </style>
</head>
<body>
    <header>
        <h1>Short Link</h1>
        <div class="auth-actions">
            <% if (locals.user) { %>
                <span style="font-weight: bold;">Hello, <%= user.name || user.email %>!</span>
                <a href="/profile" style="background-color: #006666;">Profile</a>
                <a href="/logout">Logout</a>
            <% } else { %>
                <a href="/login" style="border: 1px solid white;">Login</a>
                <a href="/signup" style="background-color: #28a745;">Sign Up</a>
            <% } %>
        </div>
    </header>

    <div class="container">
        <% if(locals.id) { %>
            <div class="link-generated" id="generatedLinkWrap">
                <p>URL Generated: <strong id="generatedLinkText"><%= BASE_URL %>/url/<%= id %></strong></p>
                <button id="copyGeneratedBtn" style="margin-left:12px; padding:8px 12px; border-radius:8px; border:none; background:#008080; color:#fff; cursor:pointer; font-weight:700;">Copy</button>
            </div>
        <% } %> 
        
        <div class="shorten-form">
            <form id="shortenForm" method="POST" action="/url">
                <label for="url">Enter Your Original URL:</label>
                <div style="display: flex; margin-top: 5px;">
                    <input id="url" type="text" name="url" placeholder="https://verylongurl.com/that/needs/shortening" required/>
                    <button type="submit">Generate</button>
                </div>
            </form>
        </div>

        <h2 style="margin-top: 40px; color: #008080;">Your Shortened Links</h2>
        <div class="urls-list">
            <% if(locals.urls && urls.length > 0) { %>
                <table>
                    <thead>
                        <tr>
                            <th>S. No</th>
                            <th>ShortID</th>
                            <th>Redirect</th>
                            <th>Clicks</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% urls.forEach((url, index) => { %>
                            <tr>
                                <td><%= index + 1 %></td>
                                <td style="display:flex;align-items:center; gap:8px;">
                                    <a href="<%= BASE_URL %>/url/<%= url.shortId %>" target="_blank" style="color:#008080; text-decoration: none;"><%= url.shortId %></a>
                                    <button class="copy-btn" data-shortid="<%= url.shortId %>" style="padding:6px 10px; border-radius:6px; border:none; background:#007b7b; color:#fff; cursor:pointer; font-weight:600;">Copy</button>
                                </td>
                                <td><%= url.redirectURL.substring(0, 50) + (url.redirectURL.length > 50 ? '...' : '') %></td>
                                <td><%= url.visitHistory.length %></td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            <% } else if (locals.user) { %>
                <p>You haven't generated any links yet. Start shortening above!</p>
            <% } else { %>
                <p>Generate up to 2 links anonymously. Login to save your links permanently.</p>
            <% } %>
        </div>

        <div id="auth-popup-backdrop" class="popup-backdrop" onclick="hidePopup()">
            <div id="auth-popup" class="popup-card" onclick="event.stopPropagation()">
                <span class="popup-close" onclick="hidePopup()">&times;</span>
                <h3>Limit Reached!</h3>
                <p style="color: #666; margin-bottom: 20px;">You have generated the maximum number of anonymous links. Please log in or sign up to continue.</p>
                <button onclick="window.location.href='/login'">Login</button>
                <button onclick="window.location.href='/signup'">Sign Up</button>
            </div>
        </div>
    </div>
<script>
    // ... (Your existing JS functions: showPopup, hidePopup, form listener)
    function showPopup() {
        document.getElementById('auth-popup-backdrop').style.display = 'block';
    }

    function hidePopup() {
        document.getElementById('auth-popup-backdrop').style.display = 'none';
    }

    document.getElementById('shortenForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const urlInput = form.querySelector('input[name="url"]').value;

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: urlInput }),
            });

            const data = await response.json();

            if (response.ok) {
                window.location.href = `/?id=${data.id}`;
            } else if (response.status === 403 && data.needAuth) {
                showPopup(); 
            } else {
                alert(data.error || 'An unknown error occurred.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An internal server error occurred.');
        }
    });

    // Copy buttons for generated and listed links
    function setCopyHandlers() {
        const generatedBtn = document.getElementById('copyGeneratedBtn');
        if (generatedBtn) {
            generatedBtn.addEventListener('click', () => {
                const text = document.getElementById('generatedLinkText').innerText;
                navigator.clipboard.writeText(text).then(() => {
                    generatedBtn.innerText = 'Copied!';
                    setTimeout(()=> generatedBtn.innerText = 'Copy', 1500);
                }).catch(()=> alert('Copy failed. Please copy manually.'));
            });
        }

        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const sid = e.currentTarget.getAttribute('data-shortid');
                const full = `${'<%= BASE_URL %>'}/url/${sid}`;
                navigator.clipboard.writeText(full).then(()=>{
                    const old = btn.innerText;
                    btn.innerText = 'Copied!';
                    setTimeout(()=> btn.innerText = old, 1500);
                }).catch(()=> alert('Copy failed. Please copy manually.'));
            });
        });
    }

    // initialize copy handlers on page load
    setCopyHandlers();
</script>
</body>
</html>